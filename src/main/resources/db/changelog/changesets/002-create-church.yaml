# db/changelog/002-church.yml
databaseChangeLog:
  - changeSet:
      id: 002-church-create
      author: erik
      changes:
        - createTable:
            tableName: church
            columns:
              - column:
                  name: id
                  type: VARCHAR(128)           # matches your @Id String (e.g., "grace-orthodox")
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: allowed_origin
                  type: VARCHAR(255)           # nullable by default
        - createIndex:
            tableName: church
            indexName: idx_church_name
            columns:
              - column:
                  name: name
      rollback:
        - dropTable:
            tableName: church
            cascadeConstraints: true

  # FK: api_keys.church_id -> church.id  (your api_keys already has church_id)
  - changeSet:
      id: 002-church-fk-api-keys
      author: erik
      preConditions:
        - onFail: MARK_RAN
        - tableExists:
            tableName: api_keys
        - columnExists:
            tableName: api_keys
            columnName: church_id
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_api_keys_church
      changes:
        - addForeignKeyConstraint:
            baseTableName: api_keys
            baseColumnNames: church_id
            referencedTableName: church
            referencedColumnNames: id
            constraintName: fk_api_keys_church
            onDelete: CASCADE
            onUpdate: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: api_keys
            constraintName: fk_api_keys_church

  # OPTIONAL FK: app_user.church_id -> church.id  (only applies if the column exists)
  - changeSet:
      id: 002-church-fk-app-user
      author: erik
      preConditions:
        - onFail: MARK_RAN
        - tableExists:
            tableName: app_user
        - columnExists:
            tableName: app_user
            columnName: church_id
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_app_user_church
      changes:
        - addForeignKeyConstraint:
            baseTableName: app_user
            baseColumnNames: church_id
            referencedTableName: church
            referencedColumnNames: id
            constraintName: fk_app_user_church
            onDelete: SET NULL         # change to CASCADE if you prefer
            onUpdate: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: app_user
            constraintName: fk_app_user_church
