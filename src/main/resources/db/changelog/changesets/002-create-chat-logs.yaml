databaseChangeLog:
  - changeSet:
      id: 2025-08-01-enable-pgcrypto
      author: emikac
      dbms: postgresql
      changes:
        - sql:
            splitStatements: false
            sql: CREATE EXTENSION IF NOT EXISTS pgcrypto;

  - changeSet:
      id: 2025-08-01-create-chat-logs
      author: emikac
      dbms: postgresql
      changes:
        - createTable:
            tableName: chat_logs
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: church_id
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: session_id
                  type: UUID
              - column:
                  name: user_question
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: bot_response
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: timestamp
                  type: TIMESTAMPTZ
                  defaultValueComputed: NOW()
              - column:
                  name: source_ip
                  type: VARCHAR(45)
              - column:
                  name: user_agent
                  type: TEXT
              - column:
                  name: metadata
                  type: JSONB

        - addDefaultValue:
            tableName: chat_logs
            columnName: id
            columnDataType: UUID
            defaultValueComputed: gen_random_uuid()

  - changeSet:
      id: 2025-08-01-chat-logs-jsonb-index
      author: emikac
      dbms: postgresql
      changes:
        - createIndex:
            indexName: chat_logs_metadata_gin_idx
            tableName: chat_logs
            columns:
              - column:
                  name: metadata
            indexType: gin
  - changeSet:
        id: 20250811-02-add-fk-church
        author: erik
        changes:
        - addForeignKeyConstraint:
            baseTableName: chat_logs
            baseColumnNames: church_id
            referencedTableName: church
            referencedColumnNames: id
            constraintName: fk_chat_log_church_id
            onDelete: CASCADE
            onUpdate: CASCADE
# db/changelog/2025-08-11-seed-chat-logs.yaml
  - databaseChangeLog:
  - changeSet:
      id: 20250811-04-seed-chat-logs-for-metrics
      author: erik
      context: dev
      changes:
        - sql:
            splitStatements: true
            stripComments: true
            sql: |
              -- Fixed IDs you can reference from chat_log_metrics.chat_log_id
              -- 1) 5f2a3b9e-22fd-4d7c-9b32-5de0bb6e7a11
              -- 2) 9c8d7b2a-6f41-4a79-8c1d-29d0a5f2e3b4
              -- 3) 2b5a9d71-1f23-4e94-b6aa-0b0fae55c6d2

              INSERT INTO chat_logs (id, church_id, session_id, user_question, bot_response, metadata)
              VALUES
                ('5f2a3b9e-22fd-4d7c-9b32-5de0bb6e7a11', 'hope-baptist', gen_random_uuid(),
                 'What time is Sunday service?', 'Sunday service starts at 10:00 AM.', '{}'::jsonb),
                ('9c8d7b2a-6f41-4a79-8c1d-29d0a5f2e3b4', 'hope-baptist', gen_random_uuid(),
                 'Where do I park?', 'Visitor parking is along the east lot near the main entrance.', '{}'::jsonb),
                ('2b5a9d71-1f23-4e94-b6aa-0b0fae55c6d2', 'hope-baptist', gen_random_uuid(),
                 'Is childcare available?', 'Yes, children''s ministry is available during the 10:00 AM service.', '{}'::jsonb)
              ON CONFLICT (id) DO NOTHING;
