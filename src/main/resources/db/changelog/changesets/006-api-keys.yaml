# db/changelog/0007-fix-api-keys-id-to-uuid.yml
databaseChangeLog:
  - changeSet:
      id: 006-api-keys
      author: erik
      changes:
        - createTable:
            tableName: api_keys
            columns:
              - column: { name: id, type: UUID, constraints: { primaryKey: true, nullable: false }, defaultValueComputed: "uuid_generate_v4()" }
              - column: { name: church_id, type: VARCHAR(255), constraints: { nullable: false } }
              - column: { name: token_hash, type: VARCHAR(255), constraints: { nullable: false } }
              - column: { name: token_prefix, type: VARCHAR(32) }
              - column: { name: description, type: VARCHAR(255) }
              - column: { name: last_used_at, type: TIMESTAMP WITH TIME ZONE }
              - column: { name: revoked_at, type: TIMESTAMP WITH TIME ZONE }
              - column: { name: created_at, type: TIMESTAMP WITH TIME ZONE, defaultValueComputed: CURRENT_TIMESTAMP }
              - column: { name: created_by, type: VARCHAR(255)}
        - addForeignKeyConstraint:
            baseTableName: api_keys
            baseColumnNames: church_id
            referencedTableName: church
            referencedColumnNames: id
            constraintName: fk_church_id
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: api_keys
            columnNames: token_hash
            constraintName: uq_api_keys_token_hash
        - createIndex:
            tableName: api_keys
            indexName: idx_api_keys_church_revoked
            columns:
              - column: { name: church_id }
              - column: { name: revoked_at }
        - createIndex:
            tableName: api_keys
            indexName: idx_api_keys_last_used_at
            columns:
              - column: { name: last_used_at }
